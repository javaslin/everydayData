## 每天一道数据开发面试题

### Flink 如何保证 exactly-Once 语义

#### 概述

- Flink使用了一种轻量级快照机制--检查点（checkpoint）来保证exactly-once语义
- 有状态流应用的一致检查点，其实就是：所有任务的状态，在某个时间点的一份拷贝（一份快照）。而这个时间点，应该是所有任务都恰好处理完一个相同的输入数据的时候。
- 应用状态的一致检查点，是Flink故障恢复机制的核心。

#### 如何保证

- beginTransaction: 初始化一个事务。在有新数据到达并且当前事务为空时调用。
- preCommit: 预提交数据，即不再写入当前事务并准好提交当前事务。在 sink 算子进行快照的时候调用。
- commit: 正式提交数据，将准备好的事务提交。在作业的 checkpoint 完成时调用。
- abort: 放弃事务。在作业 checkpoint 失败的时候调用。
- 一旦所有operator完成预提交，就提交一个commit。
- 如果至少有一个预提交失败，则所有其他提交都将中止，我们将回滚到上一个成功完成的checkpoint。
- 在预提交成功之后，提交的commit需要保证最终成功 - operator和外部系统都需要保障这点。如果commit失败（例如，由于间歇性网络问题），整个[Flink](https://zhoukaibo.com/tags/flink/)应用程序将失败，应用程序将根据用户的重启策略重新启动，还会尝试再提交。这个过程至关重要，因为如果commit最终没有成功，将会导致数据丢失。

#### 参考文章

